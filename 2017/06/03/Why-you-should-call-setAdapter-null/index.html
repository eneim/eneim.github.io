<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="description" content="eneim | the simple, the best"><meta name="keyword" content="eneim"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="Df1Qt2ADt1yncYOOFgSQqKm6MBiEXc2W7D7hr26ErEU"><meta name="description" content="TL;DR Always call RecyclerView#setAdapter(null) before your RecyclerView is going away (in onDestroy/onDestroyView/...).">
<meta name="keywords" content="Android,RecyclerView,EN,Dev,Adapter,Beginner">
<meta property="og:type" content="article">
<meta property="og:title" content="(Deprecated) Why you should call setAdapter(null)">
<meta property="og:url" content="https://ene.im/2017/06/03/Why-you-should-call-setAdapter-null/index.html">
<meta property="og:site_name" content="eneim's log">
<meta property="og:description" content="TL;DR Always call RecyclerView#setAdapter(null) before your RecyclerView is going away (in onDestroy/onDestroyView/...).">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://ene.im/2017/06/03/Why-you-should-call-setAdapter-null/activity-recreated.png">
<meta property="og:image" content="https://ene.im/2017/06/03/Why-you-should-call-setAdapter-null/destroy-do-nothing.png">
<meta property="og:image" content="https://ene.im/2017/06/03/Why-you-should-call-setAdapter-null/destroy-remove-adapter.png">
<meta property="og:updated_time" content="2019-02-28T12:08:32.994Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="(Deprecated) Why you should call setAdapter(null)">
<meta name="twitter:description" content="TL;DR Always call RecyclerView#setAdapter(null) before your RecyclerView is going away (in onDestroy/onDestroyView/...).">
<meta name="twitter:image" content="https://ene.im/2017/06/03/Why-you-should-call-setAdapter-null/activity-recreated.png">
<meta name="twitter:creator" content="@ene__im"><title>(Deprecated) Why you should call setAdapter(null)</title><link rel="shortcut icon" href="/img/eneim.ico" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><link href="/styles/zoom.css" rel="stylesheet"><link href="/styles/youtube.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpg"></div><div class="author"><div class="author-name"><a href="/">eneim</a></div><div class="about-me">the simple, the best</div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">archives</a></li><li><a href="/atom.xml">rss</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/eneim"></span><a href="https://github.com/eneim" target="_blank" rel="noreferrer" title="https://github.com/eneim">https://github.com/eneim</a></li><li class="social-item"><span class="label"><img src="/images/socials/email.svg" alt="nam@ene.im"></span><span>nam@ene.im</span></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">(Deprecated) Why you should call setAdapter(null)</div><div class="date"># 2017/06/03</div><div class="content"><meta name="generator" content="Hexo 3.8.0"><h2 id="Notice-If-you’ve-come-here-by-chance-I-want-to-say-thanks-for-the-interest"><a href="#Notice-If-you’ve-come-here-by-chance-I-want-to-say-thanks-for-the-interest" class="headerlink" title="Notice: If you’ve come here by chance, I want to say thanks for the interest."></a>Notice: If you’ve come here by chance, I want to say thanks for the interest.</h2><h2 id="And-also-want-to-have-notice-This-post-is-wrongly-representing-my-message-It-I-actually-also-uses-a-bad-example-to-raise-the-Problem-which-cause-a-misleading-discussion"><a href="#And-also-want-to-have-notice-This-post-is-wrongly-representing-my-message-It-I-actually-also-uses-a-bad-example-to-raise-the-Problem-which-cause-a-misleading-discussion" class="headerlink" title="And also want to have notice: This post is wrongly representing my message. It (I actually) also uses a bad example to raise the Problem, which cause a misleading discussion."></a>And also want to have notice: This post is wrongly representing my message. It (I actually) also uses a bad example to raise the Problem, which cause a misleading discussion.</h2><h2 id="At-the-moment-I’m-revising-my-message-as-well-as-updating-this-post-By-the-meantime-this-post-is-no-longer-a-good-place-for-reference-this-is-my-apologize"><a href="#At-the-moment-I’m-revising-my-message-as-well-as-updating-this-post-By-the-meantime-this-post-is-no-longer-a-good-place-for-reference-this-is-my-apologize" class="headerlink" title="At the moment, I’m revising my message as well as updating this post. By the meantime, this post is no longer a good place for reference, this is my apologize."></a>At the moment, I’m revising my message as well as updating this post. By the meantime, this post is no longer a good place for reference, this is my apologize.</h2><a id="more"></a>
<p><del><strong>TL;DR</strong>: Always call <code>RecyclerView#setAdapter(null)</code> before your <code>RecyclerView</code> is going away (in <code>onDestroy/onDestroyView/...</code>).</del></p>
<h1 id="1-Problem"><a href="#1-Problem" class="headerlink" title="1. Problem"></a>1. Problem</h1><p>In common tutorials about RecyclerView out there, you may see this quite frequently, inside an <code>Activity</code>‘s <code>onCreate</code> or a <code>Fragment</code>‘s <code>onCreateView</code>.</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">mAdapter = <span class="keyword">new</span> MyCoolAdapter(); <span class="comment">// here mAdapter is a member of enclosing class.</span></span><br><span class="line">recyclerView.setAdapter(adapter);</span><br></pre></td></tr></tbody></table></figure>
<p>It is pretty common step when one initialize his/her screen’s <code>RecyclerView</code>. But I rarely see people telling those “learners” what should them do on the “terminal” point. I mean, does anyone care about tearing down the RecyclerView after all?</p>
<p>One may ask: what’s wrong with that? Is <code>Activity</code> destroying everything after it is destroyed?</p>
<p>Well, for your curiosity: <strong>Will it be destroyed</strong>?</p>
<p>Let’s take a quick look at this question on StackOverflow: <a href="https://stackoverflow.com/questions/30132643/recyclerview-doesnt-unregister-itself-from-the-adapter-on-orientation-change" target="_blank" rel="noopener"><code>RecyclerView</code> doesn’t unregister itself from the adapter on orientation change</a>. I bet everyone can easily find the problem as well as the answer for it. But let me talk a bit more.</p>
<p><strong>Check points to ‘The Problem’</strong>:</p>
<ul>
<li><p>If you have used RecyclerView quite a while, you may know there are couples of useful callback for Adapter: <code>Adapter#onAttachedToRecyclerView(RecyclerView), Adapter#onDetachedFromRecyclerView(RecyclerView), Adapter#onViewAttachedToWindow(ViewHolder), Adapter#onViewDetachedFromWindow(ViewHolder)</code>.</p>
</li>
<li><p>Have you ever debuged to see when they are called? Let me sort them out for you:</p>
<ul>
<li><code>onAttachedToRecyclerView</code> is called when the Adapter is set to RecyclerView, after a call to <code>RecyclerView#setAdapter(Adapter)</code> or <code>RecyclerView#swapAdapter(Adapter, boolean)</code>. This is quite obvious.</li>
<li><code>onDetachedFromRecyclerView</code>, on the other hand, is called when current Adapter if going to be replaced by <strong><em>another Adapter</em></strong> (this another ‘Adapter’ can be Null). What is the point here: <strong>if you don’t replace the Adapter, this method will never be called.</strong> And what happens if an Adapter is never be “detached” from a RecyclerView? Let’s see after I explain about the other couples.</li>
<li><code>onViewAttachedToWindow</code> is called once RecyclerView or its LayoutManager add a View into RecyclerView (hint: go to <code>RecyclerView</code> source code and search for the following keywords: <a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/master/v7/recyclerview/src/android/support/v7/widget/RecyclerView.java#6831" target="_blank" rel="noopener">dispatchChildAttached</a>).</li>
<li><code>onViewDetachedFromWindow</code>, on opposite, is called when RecyclerView or its LayoutManager detach a View from current Window.</li>
</ul>
</li>
<li><p>What happens when an <code>Adapter</code> is not <em>detached</em> from a <code>RecyclerView</code>? The couple of attach/detach call to an Adapter is tight to another “couple method” of Adapter: <code>registerAdapterDataObserver/unregisterAdapterDataObserver</code>. In fact, <code>registerAdapterDataObserver</code> is always called with (right before) <code>onAttachedToRecyclerView</code> and <code>unregisterAdapterDataObserver</code> is always called with (right before) <code>onDetachedFromRecyclerView</code>. In depth, <code>Adapter#registerAdapterDataObserver(AdapterDataObserver)</code> will add an instance of <code>AdapterDataObserver</code> to its observer system, to broadcast the changes to <code>RecycleView</code>‘s ecosystem. And <code>unregisterAdapterDataObserver</code> will clean it up. <code>RecyclerView</code> holds an instance of <code>RecyclerViewDataObserver</code> which is a <strong>non-static inner class</strong> that extends AdapterDataObserver (hint: go searching for <code>mObserver</code> in <code>RecyclerView</code> source code). So here you see the problem?</p>
</li>
</ul>
<blockquote>
<p>→ If <code>onDetachedFromRecyclerView</code> is not called, which is equivalent to the fact that <code>unregisterAdapterDataObserver</code> will not be called, an instance of <code>RecyclerViewDataObserver</code> will stay alive inside your <code>Adapter</code> as long as that <code>Adapter</code> is alive. <code>RecyclerViewDataObserver</code>, in turn, holds a reference to its enclosing <code>RecyclerView</code>, which in turn holds a reference to its enclosing <code>Context</code>. In this case, it is your <code>Activity</code> or <code>Fragment</code>‘s host <code>Context</code> (which is 99% an <code>Activity</code>). So your <code>Activity</code> will be held there for quite a long time, longer than you may expect.</p>
</blockquote>
<h1 id="2-The-Solution"><a href="#2-The-Solution" class="headerlink" title="2. The Solution"></a>2. The Solution</h1><p>As we have discussed quite long about the Problem, let’s see how we can solve it. Since the solution is quite obvious, I would like you to not leave here right now and maybe continue reading to the next paragraph: more motivations for you to always use this solution.</p>
<p>So the solution is:</p>
<ul>
<li><p>In short: remove your Adapter from the RecyclerView as soon as your RecyclerView is going to leave. Which is equivalent to calling: <code>recyclerView.setAdapter(null)</code>.</p>
</li>
<li><p>Why this solve the problem? - by calling <code>setAdapter</code> with whatever value the Adapter is (as long as it is different to current Adapter), your RecyclerView will always detach current Adapter, which means that <code>Adapter#onDetachedFromRecyclerView</code> and <code>Adapter#unregisterAdapterDataObserver</code> will properly be called. Using a null Adapter will stop the works there. That is!</p>
</li>
</ul>
<h1 id="3-One-more-thing"><a href="#3-One-more-thing" class="headerlink" title="3. One more thing."></a>3. One more thing.</h1><p>You may say <strong><em>well, it is not bad, but I’m not convinced yet…</em></strong>, let’s keep going a bit further.<br>There is another couple I have discussed above: <code>Adapter#onViewAttachedToWindow</code> and <code>Adapter#onViewDetachedFromWindow</code>. Let see 2 (plus 1) screenshots below to see what is the difference between calling <code>setAdapter</code> to null and not calling it.</p>
<p>Note: my experiment is to setup an Activity with a RecyclerView, and by pressing “Current App Stack” button I can easily make the Activity destroy/recreated. I debug on <code>RecyclerView#onChildAttachedToWindow</code> and <code>RecyclerView#onChildDetachedFromWindow</code> which is called along with those 2 methods above, respectively.</p>
<ul>
<li>Screenshot 0: after clicking to “App Stack” button, your Activity is destroyed, and by clicking to its “Snapshot” in the stack, you bring it back to life with a “recreation” (savedInstanceState is not null).</li>
</ul>
<img src="/2017/06/03/Why-you-should-call-setAdapter-null/activity-recreated.png" title="Screenshot 0: Activity is re-created">
<ul>
<li>Screenshot 1: not calling setAdapter to null in onDestroy</li>
</ul>
<img src="/2017/06/03/Why-you-should-call-setAdapter-null/destroy-do-nothing.png" title="Screenshot 1: not calling setAdapter to null in onDestroy">
<ul>
<li>Screenshot 2: calling setAdapter to null in onDestroy</li>
</ul>
<img src="/2017/06/03/Why-you-should-call-setAdapter-null/destroy-remove-adapter.png" title="Screenshot 2: calling setAdapter to null in onDestroy">
<p>You see the difference? </p>
<ol>
<li><p>With proper call to remove the Adapter, current Views on RecyclerView are also properly detached from Window. Otherwise, your Views will not be detached, and I cannot tell where they will be after your Activity is destroyed (or maybe it will not…).</p>
</li>
<li><p>If you ignore the fact, let see further: the attached Views after your Activity is recreated are all different (see their hashCode in my Screenshot), which means that those older Views is going somewhere else, without a proper “detaching” from the old Window. Where are they? I have no idea.</p>
</li>
<li><p>Well, I maybe a bit OCD, but not seeing any “onChildDetachedFromWindow” while there is a whole bunch of “onChildAttachedToWindow” make me feel bad. Hope it is not only me out there.</p>
</li>
</ol>
<p>That’s all. Happy Coding!</p>
</div><div class="tags"><a class="tag-link" href="/tags/adapter/">Adapter</a><a class="tag-link" href="/tags/android/">Android</a><a class="tag-link" href="/tags/beginner/">Beginner</a><a class="tag-link" href="/tags/dev/">Dev</a><a class="tag-link" href="/tags/en/">EN</a><a class="tag-link" href="/tags/recyclerview/">RecyclerView</a></div></section></div><div class="container"><ul class="nav"><li>previous: <a href="/2017/06/25/toro-3-0-alpha-1-was-born-from-scratch-with-love/">Toro 3.0 alpha 1 was born, from scratch with love</a></li><li>next: <a href="/2017/04/27/The-future-of-Toro-in-relationship-with-ExoPlayer/">The future of Toro in relationship with ExoPlayer</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><span>Powered by </span><a href="http://hexo.io" target="_blank" rel="noreferrer">Hexo</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-curry" target="_blank" rel="noreferrer">Curry</a><span>.</span></div></footer><script src="/script/jquery.min.js"></script><script src="/script/transition.js"></script><script src="/script/zoom.js"></script><script src="/script/index.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-72567780-7', 'auto');
ga('send', 'pageview');</script><script src="/script/post.js"></script><script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>