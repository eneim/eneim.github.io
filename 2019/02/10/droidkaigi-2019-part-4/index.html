<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>One more thing from Droidkaigi 2019 · eneim's log</title><meta name="description" content="One more thing from Droidkaigi 2019 - Nam Nguyen"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#FB4D42"><meta name="google-site-verification" content="Df1Qt2ADt1yncYOOFgSQqKm6MBiEXc2W7D7hr26ErEU"><link rel="short icon" href="/img/eneim.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/zoom.css"><meta property="og:title" content="One more thing from Droidkaigi 2019"><meta property="og:image"><meta property="og:description" content=""></head><body><div class="wrap"><div class="header"><a href="/" class="logo-link"><img src="/img/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" rel="noreferrer" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" rel="noreferrer" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/eneim" target="_blank" rel="noreferrer" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" rel="noreferrer" class="nav-list-link">RSS</a></li></ul></div></div><section class="container"><div class="post"><article class="post-block"><div class="wrap"><h1 class="post-title">One more thing from Droidkaigi 2019</h1><h2 class="post-subtitle"></h2><header class="post-info">Feb 10, 2019<div class="fb-ir-time"><time datetime="2019-02-10T14:44:13.000Z" class="op-modified"></time><time datetime="2019-02-10T14:44:13.000Z" class="op-published"></time></div><div class="tags"><a href="/tags/Android" class="tag-link">#Android</a><a href="/tags/RecyclerView" class="tag-link">#RecyclerView</a><a href="/tags/ExoPlayer" class="tag-link">#ExoPlayer</a><a href="/tags/2019" class="tag-link">#2019</a><a href="/tags/DroidKaigi" class="tag-link">#DroidKaigi</a></div></header></div><div class="wrap"><div class="post-content"><p>If you have gone though my note about attending DroidKaigi 2019 <a href="/2019/02/10/droidkaigi-2019-part-1/">part 1</a>, <a href="/2019/02/10/droidkaigi-2019-part-2/">part 2</a>, <a href="/2019/02/10/droidkaigi-2019-part-3/">part 3</a>, I hope you will be excited about <strong>Kohii</strong> and curious about how to use it in practice.</p><p><a href="https://github.com/eneim/kohii" target="_blank" rel="noopener"><strong>Kohii</strong></a> is still designing phase, and not ready for production yet. At the moment I’m typing these lines, I already have a (kind of) new mechanism that allow client to further customize Kohii’s behavior, as well as reduce its burden which in turn improve its performance.</p><p>In this post, I would like to show how to build the following App using current <a href="https://github.com/eneim/kohii/blob/dev-v1/README.md" target="_blank" rel="noopener">release alpha04</a> of <strong>Kohii</strong>:</p><img src="/2019/02/10/droidkaigi-2019-part-4/kohii_part4_1.gif"><p>First, let I sketch out our target in this post:</p><ul><li><p>Implement ExoPlayer in a RecyclerView. Video item should start and pause playback automatically when user scrolls the list.</p></li><li><p>When user clicks to a Video item, it will open a fullscreen overlay single player. The playback should keep playing without any discontinuity.</p></li><li><p>The overlay player can be transformed to the mini form once User drag it down.</p></li><li><p>Pressing <em>Back</em> button will also transform the overlay player, if it presents, or will close the App otherwise.</p></li></ul><p>This post use <strong>Android Studio 3.4 Beta 02</strong>. Before starting, please make sure</p><ul><li>You own the content you use in the project, or at least you have enough right to use.</li></ul><h2 id="0-Start-new-project-with-necessary-dependencies"><a href="#0-Start-new-project-with-necessary-dependencies" class="headerlink" title="0. Start new project with necessary dependencies"></a>0. Start new project with necessary dependencies</h2><p>First steps would be to start new project using Android Studio. <a href="https://github.com/eneim/KohiiDemo/tree/demo/step0" target="_blank" rel="noopener">I would like to go through this step</a>.</p><h2 id="1-Update-necessary-dependencies"><a href="#1-Update-necessary-dependencies" class="headerlink" title="1. Update necessary dependencies"></a>1. Update necessary dependencies</h2><p>After finishing step 0, please add these lines below to build.gradle:</p><figure class="highlight gradle"><figcaption><span>build.gradle</span></figcaption><div style="overflow:auto"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app module's build.gradle</span></span><br><span class="line">implementation <span class="string">'androidx.constraintlayout:constraintlayout:2.0.0-alpha3'</span></span><br><span class="line"></span><br><span class="line">implementation <span class="string">"androidx.coordinatorlayout:coordinatorlayout:1.1.0-alpha01"</span></span><br><span class="line">implementation <span class="string">"androidx.recyclerview:recyclerview:1.1.0-alpha02"</span></span><br><span class="line">implementation <span class="string">"androidx.recyclerview:recyclerview-selection:1.1.0-alpha01"</span></span><br><span class="line">implementation <span class="string">"androidx.lifecycle:lifecycle-extensions:2.1.0-alpha02"</span></span><br><span class="line">implementation <span class="string">"com.google.android.material:material:1.1.0-alpha03"</span></span><br><span class="line"></span><br><span class="line">implementation <span class="string">"im.ene.kohii:kohii:1.0.0.2904-ALPHA04"</span></span><br><span class="line">implementation <span class="string">"com.google.android.exoplayer:exoplayer:2.9.4"</span></span><br></pre></td></tr></table></div></figure><p>See this <a href="https://github.com/eneim/KohiiDemo/compare/demo/step0...demo/step1?expand=1" target="_blank" rel="noopener">diff</a> for detail.</p><p>We will use <code>BottomSheetBehavior</code> with <code>MotionLayout</code> to create the <em>overlay player pane</em>.</p><h2 id="2-Preparing-base-UI-1"><a href="#2-Preparing-base-UI-1" class="headerlink" title="2. Preparing base UI (1)"></a>2. Preparing base UI (1)</h2><p>In this step, we put simple implementation for our list. Take a look at this <a href="https://github.com/eneim/KohiiDemo/compare/demo/step1...demo/step2" target="_blank" rel="noopener">diff</a> to see what has changed. And below is how this app looks right now:</p><img src="/2019/02/10/droidkaigi-2019-part-4/kohii_demo_2.gif" class="smallimg" width="256" height="480"><p>To summarize: we add the option to compile in Java 8 as ExoPlayer’s requirement. Next we add a simple ViewHolder whose contains only an ExoPlayer and a TextView. We will use this in our demo.</p><h2 id="3-Adding-Kohii-to-the-App"><a href="#3-Adding-Kohii-to-the-App" class="headerlink" title="3. Adding Kohii to the App"></a>3. Adding Kohii to the App</h2><p>In this step, we will add actual Video content in to the list, and use Kohii to make ExoPlayer works with our video list.</p><p>See this <a href="https://github.com/eneim/KohiiDemo/compare/demo/step2...demo/step3?expand=1" target="_blank" rel="noopener">diff</a> for detail about what has changed.</p><p>In this step, we first add the permission to use INTERNET because our App will load Video from it. In this demo, we will use <em>Big Buck Bunny</em> because it is open and free for non-commercial use, which is great.</p><p>In this step, we simply adding Kohii to the adapter, and then use it to build <strong>Playable</strong> and pass it down to ViewHolder. It is enough to gain the automatic play/pause behavior in our App, as below:</p><img src="/2019/02/10/droidkaigi-2019-part-4/kohii_demo_3.gif" class="smallimg" width="256" height="480"><h2 id="4-Adding-selection-configuration"><a href="#4-Adding-selection-configuration" class="headerlink" title="4. Adding selection configuration"></a>4. Adding selection configuration</h2><p>From now, we add more complicated behavior to the list, including listening to click event to the PlayerView and connect it to the SelectionTracker.</p><p>See this <a href="https://github.com/eneim/KohiiDemo/compare/demo/step3...demo/step4?expand=1" target="_blank" rel="noopener">diff</a> for detail about what has changed.</p><p>To summarize (we have a lot to summarize in this step):</p><ul><li><p>We need to create a SelectionTracker that accepts only <strong>single selection</strong> using <code>SelectionPredicates.createSelectSingleAnything()</code>.</p></li><li><p>This SelectionTracker will be passed down to Adapter. Here in the Adapter, when we create new VideoViewHolder, we also bind a click listener to the PlayerView container only. Once clicked, we will dispatch the selection to SelectionTracker.</p></li><li><p>We also need a <code>VideoTagKeyProvider</code> (extends <code>ItemKeyProvider</code>) and a <code>VideoItemLookup</code> (extends <code>ItemDetailsLookup</code>).</p></li><li><p>Finally, to combine everything to get the current progess below:</p></li></ul><img src="/2019/02/10/droidkaigi-2019-part-4/kohii_demo_4.gif" class="smallimg" width="256" height="480"><h2 id="5-Adding-the-View-for-our-overlay-player"><a href="#5-Adding-the-View-for-our-overlay-player" class="headerlink" title="5. Adding the View for our overlay player"></a>5. Adding the View for our overlay player</h2><p>This is the most complicated step. In this step, we will adding the overlay player using BottomSheetBehavior and MotionLayout.</p><p>See this <a href="https://github.com/eneim/KohiiDemo/compare/demo/step4...demo/step5?expand=1" target="_blank" rel="noopener">diff</a> to see what has changed.</p><p>Before going into the explaination, let see how our App becomes now:</p><img src="/2019/02/10/droidkaigi-2019-part-4/kohii_demo_5.gif" class="smallimg" width="256" height="480"><p>First, we need to prepare the MotionLayout that contains the layout of Single Player (the target layout when User click to a Video). Next, we need to give that MotionLayout a layoutDescription, which describe the MotionScene by which we transform the fullscreen layout to the mini overlay layout.</p><p>This MotionLayout will be contained inside a FrameLayout that has the BottomSheetBehavior.</p><p>We may not need to do this, but there is an issue I will describe below that I need to wrap the MotionLayout by a BottomSheetBehavior: Consider the scenarior when User click to a Video (which will open the fullscreen single player), and then drag it down to the mini player. Here, user open multi-windows mode. With correct instance state saving and restoring, we would expect it to keep being the mini player after the recreation. If we only use MotionLayout, we need to handle this state saving/restoring manually, and from my experience, it is quite painful. As said, it is doable, but it will be out of the scope of this post. Readers of this post are free to try. I would make further update if the task is actually trivial.</p><p>What we need to do next is to connect the selection with BottomSheet expanding/collapsing and MotionLayout transforming:</p><ul><li><p>Once a ViewHolder is selected, we expand the BottomSheet and update our PlayerView in the overlay layout with the <strong>Playable</strong> of that ViewHolder. We also need to clear the <strong>Playable</strong> of that ViewHolder, or else it will be played instead of our overlay PlayerView.</p></li><li><p>The MotionLayout will listen to BottmSheet’s sliding progress and update its progress accordingly.</p></li><li><p>The BottomSheet will be the one to consume the drag event, and MotionLayout will again listen to its sliding progress an transform to the mini form.</p></li></ul><p>One thing must be explain here is the custom <code>KohiiDemoBottomSheetBehavior</code>. By default, once the BottomSheet is at its expanded state, it will not intercept the touch event. This allow the View underneath to be touched. In our App, touching through BottomSheet while it is expanded will trigger a selection on RecyclerView, which is bad. To fix this, I extend the default BottomSheetBehavior and allow it to intercept the touch event when it is expanded.</p><p><strong>Please note that, this is only for demonstration purpose. In production, you will need proper implementation. This should depend on your logic and requirement, and it is out of the scope of this post. I will keep looking for a better implementation as well.</strong></p><p>Last but not least, you may notice the <code>SelectionViewModel</code> class. This is a technique i use to get back the selection state after a configuration change. So instead of having the setup for expanding the overlay player in 2 places (one in the selection observer callback, and one for the case we are back from a recreation, then we need to check the selection state, and then if/else hell to decide if we need to expand the overlay player or not). Using a ViewModel will help us to put our expanding logic in one logic, and update the selection state is just as simple as updating the ViewModel’s LiveData value.</p><h2 id="6-Finalize"><a href="#6-Finalize" class="headerlink" title="6. Finalize"></a>6. Finalize</h2><p>After this step, our App is almost finish. Only one thing need to taken care: we want that once User clicks the <em>Back button</em>, it would not close the App, but instead:</p><ul><li>If the overlay player is expanded, clicking <em>Back</em> will collapse it to mini form.</li><li>If the overlay player is in mini form, clicking <em>Back</em> will close it.</li><li>If the overlay player is hidden, clicking <em>Back</em> will close the App as usual.</li></ul><p>To make this happen, we simply add the following code in the <code>MainActivity</code></p><figure class="highlight kotlin"><figcaption><span>MainActivity</span></figcaption><div style="overflow:auto"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBackPressed</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!ignoreBackPress()) <span class="keyword">super</span>.onBackPressed()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">ignoreBackPress</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> overlaySheet?.let &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">when</span> &#123;</span><br><span class="line">      it.state == BottomSheetBehavior.STATE_COLLAPSED -&gt; &#123;</span><br><span class="line">        it.state = BottomSheetBehavior.STATE_HIDDEN</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      it.state == BottomSheetBehavior.STATE_EXPANDED -&gt; &#123;</span><br><span class="line">        it.state = BottomSheetBehavior.STATE_COLLAPSED</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> -&gt; <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; ?: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>This change can be seen in this <a href="https://github.com/eneim/KohiiDemo/compare/demo/step5...demo/step6?expand=1" target="_blank" rel="noopener">diff</a>.</p><p>With this change, our App is finally done. What we do in this post can be found in <a href="https://github.com/eneim/KohiiDemo" target="_blank" rel="noopener">this repository</a>, so feel free to get the source code and play with it yourself.</p><h2 id="7-Final-words"><a href="#7-Final-words" class="headerlink" title="7. Final words"></a>7. Final words</h2><p>So that is. After a long explanation of my approach, this is what you could do with it. I believe this may not be the best approach, but it works, in quite a beautiful way. I will keep working on this and hope it will help a lot of people.</p><p>Hope this post is helpful for you, and please make sure to check out the source code.</p><p>Happy scrolling and dragging!</p><div class="qrcode"><img id="post-qrcode" src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8960' height='8960' viewBox='0 0 35 35'%3e%3cpath d='M1 1h7v7h-7zM9 1h1v1h-1zM13 1h1v1h-1zM15 1h4v2h-1v1h-1v-2h-2zM21 1h1v1h-1zM23 1h3v2h-1v-1h-1v2h2v2h-2v-1h-1v-1h-1v-1h1zM27 1h7v7h-7zM2 2v5h5v-5zM10 2h1v1h1v1h1v1h2v-1h1v4h1v-2h1v2h1v1h2v1h-1v1h-1v-1h-1v-1h-3v-2h-1v2h-1v-3h-1v4h-1v2h-1v-2h-1v1h-1v-1h-1v-1h2v-5h1v1h1v-1h-1zM20 2h1v1h-1zM28 2v5h5v-5zM3 3h3v3h-3zM13 3h2v1h-2zM29 3h3v3h-3zM18 4h2v1h1v-1h1v2h-1v1h-1v1h-1v-3h-1zM10 6v2h1v-2zM21 7h1v1h-1zM23 7h1v1h1v-1h1v2h-1v1h1v1h-1v1h-1v-1h-2v1h1v1h-1v1h-1v-1h-1v1h-1v-1h-1v-1h-1v1h-1v1h-1v1h-1v-2h1v-1h1v-1h-2v-1h4v1h1v1h2v-2h1v-2h1zM1 9h1v1h-1zM5 9h1v1h-1zM23 9v1h1v-1zM26 9h5v1h-2v1h-1v1h-1v1h-1v-2h1v-1h-1zM33 9h1v1h-1zM2 10h2v1h-2zM6 10h1v1h-1zM32 10h1v1h-1zM4 11h1v1h-1zM7 11h1v1h-1zM13 11h1v2h-2v-1h1zM29 11h3v1h-3zM6 12h1v1h-1zM32 12h1v3h-1zM2 13h1v2h-1zM5 13h1v1h-1zM7 13h2v1h-2zM11 13h1v1h-1zM25 13h1v2h-1v1h1v1h2v2h-3v1h1v1h-2v1h-1v-2h1v-1h-3v-2h-2v1h1v2h-1v-1h-2v1h1v2h-3v-1h1v-2h-1v2h-1v-1h-1v-2h3v-1h1v1h1v-2h1v-1h1v-1h1v2h1v-1h2v-1h1zM27 13h1v1h-1zM29 13h1v1h-1zM6 14h1v1h-1zM12 14h1v1h1v1h-1v2h-1zM17 14h2v1h-1v1h-1zM30 14h1v1h-1zM3 15h3v1h-1v1h-1v1h-1v-1h-1v-1h1zM7 15h4v2h-3v-1h-1zM15 15h1v2h-1zM26 15h1v1h-1zM29 15h1v1h-1zM33 15h1v1h-1zM6 16h1v1h1v1h-2v1h-1v-2h1zM23 16v2h2v-1h-1v-1zM28 16h1v1h-1zM30 16h1v2h1v-2h1v1h1v1h-1v2h1v2h-1v-1h-1v-2h-3v-1h1zM1 17h1v1h1v2h1v-1h1v1h1v1h-1v1h-1v-1h-3v-1h1v-1h-1zM7 19h1v1h-1zM11 19h1v1h-1zM28 19h1v1h1v2h-3v-1h1zM8 20h1v1h1v1h-1v1h-1v-1h-2v-1h2zM20 20h1v2h2v1h1v-1h1v2h-2v2h-1v-2h-1v-1h-1v1h-1v2h-1v-1h-2v-1h-2v-1h3v1h1v-1h1v-1h1zM11 21h2v1h1v1h-1v3h2v2h1v1h1v1h-2v2h1v1h1v1h-2v-1h-1v-1h-1v-1h1v-1h-2v-2h-1v-1h-1v1h-1v-4h1v1h1v1h1v-1h-1zM31 21h1v3h-1v2h2v4h1v1h-3v-1h1v-2h-1v2h-2v1h-3v-1h-2v-2h1v-1h-1v-1h1v-1h1v-3h1v1h1v1h-1v1h1v-1h1v-1h2zM1 22h1v1h-1zM3 23h1v1h1v1h3v1h-7v-1h2zM5 23h1v1h-1zM7 23h1v1h-1zM33 23h1v3h-1v-1h-1v-1h1zM20 25h1v1h-1zM16 26h2v1h-1v1h-1zM21 26h1v1h-1zM26 26v3h3v-3zM1 27h7v7h-7zM18 27h1v1h1v1h2v1h-1v2h2v2h-1v-1h-2v-3h-1v-1h-1zM22 27h2v1h-1v1h-1zM27 27h1v1h-1zM2 28v5h5v-5zM10 28h1v1h-1zM13 28v1h1v-1zM3 29h3v3h-3zM9 29h1v1h-1zM17 30h1v2h-1zM22 30h2v1h-2zM10 31h1v1h-1zM24 31h1v1h-1zM30 31h1v3h-4v-1h2v-1h1zM18 32h1v2h-1zM25 32h1v2h-2v-1h1zM33 32h1v2h-2v-1h1zM9 33h5v1h-5z'/%3e%3c/svg%3e" style="width:128px;height:128px"><p class="notice">Scan the QR code to share this article</p></div></div></div></article></div><div class="money-like"><script type="text/javascript" src="https://ko-fi.com/widgets/widget_2.js"></script><script type="text/javascript">kofiwidget2.init("Send eneim a cup of Koffee? ^^!","#6e61ab","A342OWW"),kofiwidget2.draw()</script></div></section><div class="wrap"><footer><div class="paginator"><a href="/2019/02/10/droidkaigi-2019-part-3/" class="next">OLDER</a></div><div id="disqus_thread"></div><script>var disqus_shortname="eneim",disqus_identifier="2019/02/10/droidkaigi-2019-part-4/",disqus_title="One more thing from Droidkaigi 2019",disqus_url="https://ene.im/2019/02/10/droidkaigi-2019-part-4/",disqus_config=function(){this.page.url=disqus_url,this.page.identifier=disqus_identifier};!function(){var i=document.createElement("script");i.type="text/javascript",i.async=!0,i.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(i)}()</script><script id="dsq-count-scr" src="//undefined.disqus.com/count.js" async></script><div class="copyright"><p>© 2016 - 2019 <a href="https://ene.im">Nam Nguyen</a>, unless otherwise noted.</p></div></footer></div><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga||(e.ga=function(){(e.ga.q=e.ga.q||[]).push(arguments)}),e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-72567780-7","auto"),ga("send","pageview")</script><script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script><script src="/js/transition.js"></script><script src="/js/zoom.js"></script></body></html>