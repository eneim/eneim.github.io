<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Droidkaigi 2019 (part 3) · eneim's log</title><meta name="description" content="Droidkaigi 2019 (part 3) - Nam Nguyen"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#FB4D42"><meta name="google-site-verification" content="Df1Qt2ADt1yncYOOFgSQqKm6MBiEXc2W7D7hr26ErEU"><link rel="short icon" href="/img/eneim.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="/css/zoom.css"><meta property="og:title" content="Droidkaigi 2019 (part 3)"><meta property="og:image"><meta property="og:description" content=""></head><body><div class="wrap"><div class="header"><a href="/" class="logo-link"><img src="/img/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" rel="noreferrer" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" rel="noreferrer" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/eneim" target="_blank" rel="noreferrer" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" rel="noreferrer" class="nav-list-link">RSS</a></li></ul></div></div><section class="container"><div class="post"><article class="post-block"><div class="wrap"><h1 class="post-title">Droidkaigi 2019 (part 3)</h1><h2 class="post-subtitle"></h2><header class="post-info">Feb 10, 2019<div class="fb-ir-time"><time datetime="2019-02-10T14:44:08.000Z" class="op-modified"></time><time datetime="2019-02-10T14:44:08.000Z" class="op-published"></time></div><div class="tags"><a href="/tags/Android" class="tag-link">#Android</a><a href="/tags/RecyclerView" class="tag-link">#RecyclerView</a><a href="/tags/ExoPlayer" class="tag-link">#ExoPlayer</a><a href="/tags/2019" class="tag-link">#2019</a><a href="/tags/DroidKaigi" class="tag-link">#DroidKaigi</a></div></header></div><div class="wrap"><div class="post-content"><p>This is the first part in my series about my talk at <a href="https://droidkaigi.jp/2019/" target="_blank" rel="noopener">DroidKaigi 2019</a>. You can find the rest of them below:</p><ul><li><a href="/2019/02/10/droidkaigi-2019-part-1/">Part 1</a></li><li><a href="/2019/02/10/droidkaigi-2019-part-2/">Part 2</a></li><li><a href="/2019/02/10/droidkaigi-2019-part-3/">Part 3 (this post)</a></li><li><a href="/2019/02/10/droidkaigi-2019-part-4/">Part 4</a></li></ul><p>In <a href="/2019/02/10/droidkaigi-2019-part-1/">part 1</a> and <a href="/2019/02/10/droidkaigi-2019-part-2/">part 2</a>, I have discussed about how challenging it is to have ExoPlayer work in RecyclerView, and part of my proposal, to solve those challenges. In this part, I would continue with how resource management is implemented in my approach. And with it, how could I build comlicated UX with ease.</p><img src="/2019/02/10/droidkaigi-2019-part-3/kohii_demo_1.gif"><p><em>You may notice some lagging in this gif. This was because Android Studio is not so good in recording screen of Emulator device.</em></p><h2 id="3-Resource-management-amp-More"><a href="#3-Resource-management-amp-More" class="headerlink" title="3. Resource management &amp; More"></a>3. Resource management &amp; More</h2><p>First, let me repeat my principle when designing this approach again:</p><ul><li>Balanced UX and performance<ul><li>2019 devices has more RAM than my Mac</li><li>And more CPU cores too</li><li>UX gain requries Performance loss</li></ul></li><li>Avoid resource reloading as much as possible.<ul><li>No reload on config change</li></ul></li><li>Well lifecycle control does the magic<ul><li>Design lifecycle flow if need</li></ul></li></ul><p>In part 2, my components could easily accomplish the last 2 principles. What remains is <strong>The balance between UX and performance</strong>.</p><p>First, let get back to how <strong>Playback</strong> and <strong>Playable</strong> and <strong>Target</strong> work together:</p><img src="/2019/02/10/droidkaigi-2019-part-3/kohii_part3_1.gif"><p>So all the actual playback will be dispatched to <strong>Playable</strong> once <strong>Playback</strong> receives the signal from <strong>Target</strong> behavior. You can think that: if I implementation actual playback logic in <strong>Playable</strong>, it will finish our approach here, and because <strong>Playable</strong> is created on demand, and kept alive across complicated lifecycle transitions, and will be cleaned up once the <strong>Playback</strong> for it is no longer available (which means that <strong>Playable</strong> is not bound to any <strong>Target</strong>). This way, we ensure that there is no <strong>Playable</strong> lives longer than it should be, and the number of <strong>Playable</strong> available at a time should be less than or equal to the number of <strong>Target</strong> available on the screen (eg: number of PlayerView visible on screen).</p><p>Here I say “less than or equal” because, depending on the implementation, the number of <strong>Playable</strong> will in fact not acceed that of <strong>Target</strong>. On the other hand, an unbound <strong>Playable</strong> will be ignore, which explains the “less than or equal”.</p><p>In my implementation, I would like to make <strong>Playable</strong> to be more flexible: because we do not care about actual playback logic here, so if we don’t limit ourselves to just Video playback, but to whatever <em>playable</em> (eg: gif), we can build much more useful things with these components.</p><p>To make <strong>Playable</strong> extensible, I define one more abstract component that provides actual playback logic, and let <strong>Playable</strong> to depend on it. I call it the <strong>Bridge</strong>:</p><figure class="highlight plain"><div style="overflow:auto"><table><tr><td class="code"><pre><span class="line">Bridge: provides Playable with actual playback resource/logic</span><br></pre></td></tr></table></div></figure><p>Below is how <strong>Bridge</strong> looks like, and why it will empower the whole system:</p><img src="/2019/02/10/droidkaigi-2019-part-3/kohii_part3_2.gif"><p>As you can see, <strong>Bridge</strong> shares almost the same interface with <strong>Playable</strong>. Once created, <strong>Playable</strong> will also create a <strong>Bridge</strong> and levarage the callback from <strong>Playback</strong> to it. As <strong>Playable</strong> is bound to <strong>Target</strong>, it will then pass that <strong>Target</strong> to <strong>Bridge</strong> accordingly. When the <strong>Playback</strong> is no longer available, <strong>Playable</strong> will then release the <strong>Bridge</strong> and cleans up itself, make sure no resources leaking.</p><p>With this design, I can put whatever playback logic I want to the system, via the detailed implementation of <strong>Bridge</strong> (yeah, that’s why I name it <em>Bridge</em>). It can use the backend API from ExoPlayer, or MediaPlayer for fallback, or the <em>ijkplayer</em> which is another well-known media playback library built on top of <strong>ffmpeg</strong>, or something else (APIs for non-Video playback for example).</p><p>Below figure shows the flexible in practice:</p><img src="/2019/02/10/droidkaigi-2019-part-3/kohii_part3_3.gif"><p>The left video is my current implementation, and the one on the right uses the dummy Bridge implementation to showcase in DroidKaigi (which I could not &gt;.&lt;).</p><p>It is about how flexible this approach can be. Next, I will talk about the Brigde for ExoPlayer: <strong>ExoBridge</strong>.</p><p>Before going into this implementation, below is the core definition of a <strong>Bridge</strong></p><figure class="highlight kotlin"><figcaption><span>Bridge</span></figcaption><div style="overflow:auto"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Bridge</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  set/get</span></span><br><span class="line">  <span class="keyword">var</span> playerView: PlayerView?</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">prepare</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** [com.google.android.exoplayer2.Player.setPlayWhenReady] to true */</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">play</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** [com.google.android.exoplayer2.Player.setPlayWhenReady] to false */</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">pause</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">release</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><h4 id="3-1-ExoBridge-implementation"><a href="#3-1-ExoBridge-implementation" class="headerlink" title="3.1 ExoBridge implementation"></a>3.1 ExoBridge implementation</h4><p><strong>First</strong>, here is the principle that ExoBridge bases on:</p><figure class="highlight plain"><div style="overflow:auto"><table><tr><td class="code"><pre><span class="line">- “More than one ExoPlayer instance” strategy</span><br><span class="line">  - Globally manage a Player Pool.</span><br><span class="line">  - Create ExoPlayer instance on demand, release to Pool for reuse.</span><br><span class="line">  - Cleanup Pool when no Managers are available.</span><br><span class="line">- Prepare resources as late as possible: in playable.play()</span><br><span class="line">  - Resource warming up will affect the scroll performance.</span><br><span class="line">  - Too early = frame drop at bad timing.</span><br></pre></td></tr></table></div></figure><p>Implementation of ExoBridge can be summarized as below:</p><figure class="highlight plain"><div style="overflow:auto"><table><tr><td class="code"><pre><span class="line">- Global Singleton manages Player instances in Pool</span><br><span class="line">  - Create and Release by Bridge’s demand.</span><br><span class="line">- Target: PlayerView.</span><br><span class="line">- prepare(): Do nothing to ExoPlayer resource. Just to init listeners.</span><br><span class="line">- play(): lazily create resource, then call play from ExoPlayer instance.</span><br><span class="line">  - Ensure ExoPlayer instance, create if need. </span><br><span class="line">  - Ensure MediaSource instance, create if need.</span><br><span class="line">- pause(): normally pause if in playing state</span><br><span class="line">- release(): release MediaSource, “release” ExoPlayer instance to </span><br><span class="line">ExoPlayer instance Pool</span><br><span class="line">- ExoPlayer is actually released when no Managers are available</span><br></pre></td></tr></table></div></figure><p>You can find the full-version of this in <a href="https://github.com/eneim/kohii/blob/dev-v1/kohii/src/main/java/kohii/v1/exo/ExoBridge.kt" target="_blank" rel="noopener">my repository</a>.</p><p>Bring it all together, we have the following figure, describing how my approach works:</p><img src="/2019/02/10/droidkaigi-2019-part-3/kohii_part3_4.gif"><p>And finally, below is how you can use it from your code:</p><figure class="highlight kotlin"><div style="overflow:auto"><table><tr><td class="code"><pre><span class="line">Kohii[activity].setUp(videoUrl)</span><br><span class="line">  .copy(tag = videoUrl)</span><br><span class="line">  .asPlayable()</span><br><span class="line">  .bind(playerView)</span><br></pre></td></tr></table></div></figure><p>With one line above, your <code>playerView</code> will be prepared once visible, and start the playback automatically. If user scrolls the <code>playerView</code> offscreen (or partly visible, not good enough for UX), it will pause the playback automatically.</p><p>If you want to keep this playback continues in new lifecycle (says new Activity), in that Activity’s onCreate or onStart, call:</p><figure class="highlight kotlin"><div style="overflow:auto"><table><tr><td class="code"><pre><span class="line">Kohii[activity].findPlayable(tag = videoUrl)</span><br><span class="line">  ?.bind(playerView)</span><br></pre></td></tr></table></div></figure><p>For exact usage, please refer to <a href="https://github.com/eneim/kohii" target="_blank" rel="noopener">the repository</a>.</p><p>That is. I have shared with all of you about my new approach for using <strong>ExoPlayer in RecyclerView</strong>. At the moment, many design concepts are in my bluesprint. I’m working hard to bring it to life and hoping it can help a lot of developers those are having the same need can find one more solution.</p><div class="qrcode"><img id="post-qrcode" src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8960' height='8960' viewBox='0 0 35 35'%3e%3cpath d='M1 1h7v7h-7zM9 1h1v1h-1zM13 1h1v1h-1zM15 1h4v2h-1v1h-1v-2h-2zM21 1h1v1h-1zM23 1h3v2h-1v-1h-2zM27 1h7v7h-7zM2 2v5h5v-5zM20 2h1v1h-1zM22 2h1v2h-1zM28 2v5h5v-5zM3 3h3v3h-3zM11 3h1v1h1v-1h2v1h-1v1h-1v2h-1v3h-1v1h-1v-1h-1v1h-1v-1h-1v-1h2v-5h1v1h1v1h-1v2h1v-2h1v-1h-1zM29 3h3v3h-3zM15 4h1v4h1v-2h1v2h1v1h2v1h-1v1h-1v-1h-1v-1h-3v-2h-1v-2h1zM18 4h2v1h1v-1h1v2h-1v1h-1v1h-1v-3h-1zM23 4h3v2h-2v-1h-1zM13 7h1v2h-1zM21 7h1v1h-1zM23 7h1v1h1v-1h1v2h-1v1h1v1h-1v1h-1v-1h-2v1h1v1h-1v1h-1v-1h-1v1h-1v-1h-1v-1h-1v1h-1v1h-1v1h-1v-2h1v-1h1v-1h-2v-1h4v1h1v1h2v-2h1v-2h1zM1 9h1v1h-1zM5 9h1v1h-1zM23 9v1h1v-1zM26 9h5v1h-2v1h-1v1h-1v1h-1v-2h1v-1h-1zM33 9h1v1h-1zM2 10h2v1h-2zM6 10h1v1h-1zM32 10h1v1h-1zM4 11h2v3h-1v-2h-1zM7 11h1v1h-1zM11 11h1v1h-1zM13 11h1v2h-2v-1h1zM29 11h3v1h-3zM1 12h1v2h-1zM32 12h1v3h-1zM7 13h2v1h-2zM11 13h1v1h-1zM25 13h1v2h-1v1h1v1h2v2h-3v1h1v1h-2v1h-1v-2h1v-1h-3v-2h-2v1h1v2h-1v-1h-2v1h1v2h-2v1h1v1h1v-1h1v-1h1v-2h1v2h2v1h1v-1h1v2h-2v2h-1v-2h-1v-1h-1v1h-1v2h-1v-1h-2v-1h-3v2h1v1h2v-1h2v1h-1v1h-2v1h2v1h-2v2h1v1h1v1h-2v-1h-1v-1h-1v-1h1v-3h-1v2h-2v-1h-1v-1h-1v-3h-1v-1h-1v-1h3v2h1v1h-1v1h1v-1h1v-1h-1v-2h1v-1h-2v-3h1v1h1v1h2v-1h2v-1h-1v-1h1v-1h1v1h1v-2h1v-1h1v-1h1v2h1v-1h2v-1h1zM27 13h1v1h-1zM29 13h1v1h-1zM2 14h1v1h-1zM6 14h1v1h-1zM9 14h1v1h-1zM12 14h1v1h-1zM17 14h2v1h-1v1h-1zM30 14h1v1h-1zM4 15h2v1h-1v1h-1zM7 15h2v1h-2zM10 15h1v2h-1zM13 15h1v1h-1zM15 15h1v2h-1zM26 15h1v1h-1zM29 15h1v1h-1zM33 15h1v1h-1zM2 16h1v1h-1zM6 16h1v1h1v1h-2v1h-1v-2h1zM12 16h1v2h-1zM23 16v2h2v-1h-1v-1zM28 16h1v1h-1zM30 16h1v2h1v-2h1v1h1v1h-1v2h1v2h-1v-1h-1v-2h-3v-1h1zM1 17h1v1h-1zM2 18h1v1h-1zM13 18h1v2h-1zM1 19h1v1h-1zM4 19h1v2h-3v-1h2zM6 19h2v1h-1v1h1v-1h1v2h-4v-1h1zM28 19h1v1h1v2h-3v-1h1zM1 21h1v2h-1zM31 21h1v3h-1v2h2v4h1v1h-3v-1h1v-2h-1v2h-2v1h-3v-1h-2v-2h1v-1h-1v-1h1v-1h1v-3h1v1h1v1h-1v1h1v-1h1v-1h2zM14 22v1h1v-1zM3 23h3v1h-3zM33 23h1v3h-1v-1h-1v-1h1zM1 25h2v1h-2zM4 25h4v1h-4zM20 25h1v1h-1zM21 26h1v1h-1zM26 26v3h3v-3zM1 27h7v7h-7zM18 27h1v1h1v1h2v1h-1v2h2v2h-1v-1h-2v-3h-1v-1h-1zM22 27h2v1h-1v1h-1zM27 27h1v1h-1zM2 28v5h5v-5zM3 29h3v3h-3zM9 29h1v1h-1zM17 30h1v2h-1zM22 30h2v1h-2zM10 31h1v1h-1zM24 31h1v1h-1zM30 31h1v3h-4v-1h2v-1h1zM18 32h1v2h-1zM25 32h1v2h-2v-1h1zM33 32h1v2h-2v-1h1zM9 33h5v1h-5z'/%3e%3c/svg%3e" style="width:128px;height:128px"><p class="notice">Scan the QR code to share this article</p></div></div></div></article></div><div class="money-like"><script type="text/javascript" src="https://ko-fi.com/widgets/widget_2.js"></script><script type="text/javascript">kofiwidget2.init("Send eneim a cup of Koffee? ^^!","#6e61ab","A342OWW"),kofiwidget2.draw()</script></div></section><div class="wrap"><footer><div class="paginator"><a href="/2019/02/10/droidkaigi-2019-part-4/" class="prev">NEWER</a><a href="/2019/02/10/droidkaigi-2019-part-2/" class="next">OLDER</a></div><div id="disqus_thread"></div><script>var disqus_shortname="eneim",disqus_identifier="2019/02/10/droidkaigi-2019-part-3/",disqus_title="Droidkaigi 2019 (part 3)",disqus_url="https://ene.im/2019/02/10/droidkaigi-2019-part-3/",disqus_config=function(){this.page.url=disqus_url,this.page.identifier=disqus_identifier};!function(){var i=document.createElement("script");i.type="text/javascript",i.async=!0,i.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(i)}()</script><script id="dsq-count-scr" src="//undefined.disqus.com/count.js" async></script><div class="copyright"><p>© 2016 - 2019 <a href="https://ene.im">Nam Nguyen</a>, unless otherwise noted.</p></div></footer></div><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga||(e.ga=function(){(e.ga.q=e.ga.q||[]).push(arguments)}),e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-72567780-7","auto"),ga("send","pageview")</script><script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script><script src="/js/transition.js"></script><script src="/js/zoom.js"></script></body></html>